import pandas as pd
import numpy as np
from my_functions import marc_parser_1_field, df_to_gsheet, cSplit, df_to_mrc, gsheet_to_df, f, cosine_sim_2_elem, get_cosine_result
import re
import pandasql
import json
import requests
import io
import cx_Oracle
import regex
from functools import reduce
import glob
import itertools
import Levenshtein as lev

def chunks(l, n):
    for i in range(0, len(l), n):
        yield l[i:i+n]

path = 'F:/Cezary/Documents/IBL/Migracja z BN/bn_all/'
#path = 'C:/Users/User/Documents/bn_all/'
files = [file for file in glob.glob(path + '*.mrk8', recursive=True)]

encoding = 'utf-8'
magazine_list = []
for i, file_path in enumerate(files):
    print(str(i) + '/' + str(len(files)))
    marc_list = io.open(file_path, 'rt', encoding = encoding).read().splitlines()
    marc_list = [elem for elem in marc_list if elem.startswith('=773')]
    magazine_list += marc_list

list_of_magazine_list = list(chunks(magazine_list, 10000))
bn_magazines = pd.DataFrame()
for i, elem in enumerate(list_of_magazine_list):
    print(str(i) + '/' + str(len(list_of_magazine_list)))
    df = pd.DataFrame(elem, columns=['bn_magazine'])
    df['bn_magazine'] = df['bn_magazine'].apply(lambda x: x[6:])
    df['index'] = df.index + 1
    df = marc_parser_1_field(df, 'index', 'bn_magazine', '\$')[['index', '$t']].rename(columns={'$t':'bn_magazine'})
    bn_magazines = bn_magazines.append(df)
    
bn_magazines = bn_magazines.groupby(['bn_magazine']).count().reset_index(level=['bn_magazine']).rename(columns={'index':'count'}).sort_values('count', ascending=False)
bn_magazines.to_excel('bn_magazines.xlsx', index=False)

bn_magazines = pd.read_excel('bn_magazines.xlsx')
bn_magazines = bn_magazines[bn_magazines['bn_magazine'].notnull()]

dsn_tns = cx_Oracle.makedsn('pbl.ibl.poznan.pl', '1521', service_name='xe')
connection = cx_Oracle.connect(user='IBL_SELECT', password='CR333444', dsn=dsn_tns, encoding='windows-1250')

pbl_query = """select zr.zr_zrodlo_id, zr.zr_tytul
            from IBL_OWNER.pbl_zrodla zr"""

pbl_magazines = pd.read_sql(pbl_query, connection)
# =============================================================================
# pbl_magazines_ok = gsheet_to_df('1V6BreA4_cEb3FRvv53E5ri2Yl1u3Z2x-yQxxBbAzCeo', 'Arkusz1')
# pbl_magazines = pbl_magazines[~pbl_magazines['ZR_TYTUL'].isin(pbl_magazines_ok['pbl_magazine'])]
# =============================================================================
    
pbl_lista = pbl_magazines['ZR_TYTUL'].to_list()    
bn_lista = bn_magazines['bn_magazine'].to_list()   

combinations = list(itertools.product(pbl_lista, bn_lista))

df = pd.DataFrame(combinations, columns=['pbl_magazine', 'bn_magazine'])
df['similarity'] = df.apply(lambda x: get_cosine_result(x['pbl_magazine'], x['bn_magazine']), axis=1)
df = df[df['similarity'] > 0.35].sort_values(['pbl_magazine', 'similarity'], ascending=[True, False])

df.to_excel('mapowanie_czasopism_PBL_BN.xlsx', index=False)


# nowe czasopisma z BN w PBL - wydobycie listy nieutożsamionych tytułów - 25.01.2021

dsn_tns = cx_Oracle.makedsn('pbl.ibl.poznan.pl', '1521', service_name='xe')
connection = cx_Oracle.connect(user='IBL_SELECT', password='CR333444', dsn=dsn_tns, encoding='windows-1250')

mamy = [30, 31, 35, 37, 38, 39, 175, 176, 177, 178, 179, 181, 40, 41, 84, 81, 82, 83, 183, 148, 149, 153, 154, 85, 86, 87, 49, 45, 46, 47, 185, 186, 188, 189, 190, 48, 50, 51, 53, 90, 91, 92, 191, 192, 194, 195, 197, 94, 95, 96, 97, 98, 55, 57, 201, 202, 203, 156, 158, 159, 161, 60, 62, 65, 66, 101, 102, 162, 163, 205, 206, 207, 208, 103, 107, 109, 110, 67, 209, 210, 211, 213, 214, 215, 68, 69, 70, 73, 74, 75, 76, 77, 78, 216, 217, 204, 79, 111, 112, 113, 116, 117, 118, 268, 269, 218, 219, 220, 221, 222, 119, 123, 126, 224, 225, 226, 272, 274, 130, 165, 276, 277, 279, 280, 281, 229, 230, 170, 171, 136, 138, 231, 232, 236, 237, 140, 142, 143, 144, 172, 282, 284, 285, 289, 290, 400, 292, 401, 402, 435, 437, 438, 439, 440, 293, 294, 296, 297, 298, 299, 300, 443, 444, 445, 406, 407, 408, 301, 305, 307, 308, 310, 311, 411, 412, 414, 312, 313, 314, 347, 349, 446, 448, 450, 451, 417, 418, 351, 355, 315, 316, 318, 319, 321, 421, 422, 424, 425, 323, 324, 358, 361, 426, 456, 457, 458, 363, 366, 325, 327, 462, 427, 429, 430, 431, 433, 329, 330, 332, 334, 434, 474, 463, 466, 467, 367, 370, 371, 372, 374, 375, 376, 470, 471, 472, 473, 477, 478, 377, 335, 336, 338, 340, 342, 479, 480, 482, 522, 523, 524, 526, 345, 392, 378, 382, 383, 527, 529, 530, 531, 532, 485, 384, 386, 389, 393, 394, 395, 397, 488, 489, 490, 491, 492, 493, 534, 398, 536, 538, 539, 540, 541, 542, 501, 505, 507, 535, 602, 604, 638, 641, 508, 543, 544, 545, 549, 687, 650, 655, 550, 552, 553, 510, 511, 512, 657, 658, 514, 561, 562, 554, 556, 665, 557, 558, 559, 560, 563, 564, 668, 565, 566, 567, 569, 570, 571, 707, 710, 712, 671, 573, 611, 614, 676, 678, 575, 576, 577, 580, 581, 714, 716, 718, 720, 721, 620, 723, 680, 683, 586, 731, 732, 726, 728, 596, 630, 633, 729, 730, 733, 734, 636, 772, 735, 736, 738, 739, 741, 836, 774, 777, 778, 780, 742, 743, 837, 838, 839, 840, 841, 842, 948, 949, 744, 748, 749, 750, 751, 752, 951, 952, 953, 955, 956, 843, 785, 786, 788, 790, 791, 792, 845, 846, 847, 966, 967, 968, 969, 971, 793, 753, 754, 759, 760, 761, 972, 957, 959, 960, 961, 963, 964, 965, 1011, 1012, 1013, 794, 796, 797, 798, 800, 801, 1014, 1016, 973, 974, 975, 976, 977, 978, 979, 980, 803, 805, 764, 766, 768, 812, 981, 982, 983, 1017, 1019, 1020, 1021, 1022, 1023, 1024, 815, 806, 807, 809, 810, 1026, 1027, 984, 985, 986, 987, 988, 989, 990, 991, 811, 850, 851, 818, 819, 820, 992, 993, 994, 1028, 1029, 1030, 1031, 1032, 1033, 821, 822, 824, 854, 855, 1034, 1035, 1036, 1037, 995, 996, 997, 998, 1000, 856, 858, 859, 860, 861, 862, 1001, 1002, 1003, 1004, 1038, 1039, 1040, 1041, 1042, 826, 827, 828, 829, 830, 831, 832, 833, 1044, 1045, 1046, 1051, 1006, 1007, 1008, 1009, 1010, 902, 922, 923, 924, 925, 1057, 1058, 1060, 1061, 1062, 1063, 1049, 1050, 1052, 1054, 1055, 947, 835, 1229, 1230, 1231, 1232, 1233, 1165, 1166, 1056, 1102, 1103, 1104, 1105, 1064, 1065, 1066, 1067, 1167, 1170, 1171, 1172, 1178, 1234, 1069, 1070, 1074, 1072, 1075, 1076, 1106, 1107, 1108, 1109, 1235, 1237, 1238, 1239, 1240, 1110, 1112, 1113, 1114, 1115, 1116, 1117, 1077, 1080, 1243, 1244, 1180, 1181, 1182, 1183, 1184, 1185, 1186, 1081, 1082, 1083, 1084, 1085, 1086, 1087, 1120, 1121, 1187, 1189, 1245, 1281, 1059, 1122, 1123, 1124, 1125, 1126, 1127, 1128, 1129, 1130, 1321, 1322, 1191, 1192, 1193, 1362, 1363, 1088, 1089, 1090, 1091, 1092, 1093, 1094, 1095, 1096, 1364, 1365, 1366, 166, 1323, 1341, 962, 1169, 1131, 1132, 1133, 1134, 1135, 1136, 1137, 1139, 1140, 1361, 1429, 1430, 1367, 1141, 1097, 1098, 1099, 1100, 1149, 1150, 1151, 1368, 1369, 958, 1381, 1382, 1383, 1384, 1385, 1386, 1152, 1154, 1142, 1143, 1144, 1145, 1146, 1147, 1194, 1138, 1155, 1156, 1157, 1158, 1159, 1160, 1161, 1401, 1404, 1405, 1406, 1407, 1162, 1163, 1164, 1223, 1226, 1227, 1228, 1422, 1423, 1424, 1425, 1426, 1427, 1428, 1409, 1410, 1411, 1421, 1558, 1560, 1561, 1562, 1564, 1565, 1566, 1581, 1582, 1583, 1589, 1590, 1591, 1521, 1541, 1542, 1830, 1073, 1543, 1544, 1605, 1607, 1608, 1609, 1840, 1853, 1854, 1856, 1610, 1614, 309, 1615, 1624, 1868, 1871, 1625, 1626, 1627, 1628, 1629, 1630, 1547, 1549, 1550, 1553, 1554, 1555, 1556, 1557, 1875, 1876, 1901, 1902, 1904, 1905, 1906, 1681, 1683, 1684, 1685, 1687, 1688, 1689, 1907, 1908, 1909, 1910, 1922, 1923, 1942, 2001, 1631, 1632, 1633, 1634, 2121, 198, 304, 461, 502, 180, 2141, 2101, 2102, 2103, 970, 1015, 1025, 2142, 2143, 2146, 2162, 2182, 2222, 2241, 2285, 1068, 2287, 2301, 2302, 2303, 2478, 2307, 2308, 2311, 2312, 2321, 2324, 2325, 2328, 2329, 2330, 2333, 2334, 2335, 2336, 2339, 2516, 2519, 2521, 2340, 2341, 2342, 2344, 2345, 2346, 2348, 2550, 2590, 2591, 2352, 2353, 2354, 2355, 2357, 2358, 2360, 2616, 2361, 2363, 2393, 2394, 2395, 2396, 2617, 2631, 533, 2651, 2652, 2413, 2414, 2415, 2419, 2420, 2421, 2313, 61, 2654, 2655, 1545, 460, 2310, 2657, 114, 2326, 2659, 2660, 2359, 2665, 2666, 2668, 2669, 2670, 2671, 2687, 2688, 2707, 2748, 2767, 2927, 2967, 2987, 3007, 3047, 3068, 2788, 2848, 2850, 2851, 2853, 3087, 3127, 3147, 3167, 3187, 3227, 3247, 3287, 3288, 3289, 3307, 3347, 3388, 3390, 3391, 3407, 3447, 3507, 3527, 3547, 3607, 3627, 2854, 2855, 2856, 2857, 2867, 2887, 2907, 3879, 3880, 2331, 43, 453, 365, 3067, 787, 58, 3528, 184, 515, 1408, 452, 3717, 612, 2347, 2362, 2323, 3890, 3891, 3747, 3767, 3787, 3807, 3893, 3894, 3895, 3896, 3907, 3911, 3867, 2144, 3868, 1551, 3869, 475, 3928, 3932, 3934, 3947, 99, 757, 1604, 3870, 353, 484, 495, 3967, 3987, 4007, 4047, 4067, 4068, 4107, 4127, 4147, 2337, 2284, 2322, 1682, 432, 3871, 4167, 4307, 4347, 4367, 4387, 4388, 3872, 3873, 3874, 286, 416, 3875, 4389, 4427, 4447, 4448, 4467, 4487, 4488, 4547, 317, 3876, 3878, 483, 1613, 4567, 4587, 4647, 4648, 4649, 4687, 4707, 4727, 4747, 4787, 4788, 4789, 4790, 4827, 4847, 3467, 3107, 1403, 476, 328, 3387, 4867, 4868, 4869, 4870, 4887, 4888, 4889, 4907, 4967, 2201, 428, 360, 626, 4987, 5007, 5027, 5028, 5029, 5030, 5047, 5048, 5068, 5087, 5107, 5127, 1546, 5187, 436, 724, 1623, 6007, 6008, 6009, 6010, 6011, 6012, 6013, 574, 5227, 3327, 145, 465, 2661, 6014, 6015, 6016, 6017, 6018, 6019, 6020, 6021, 6023, 494, 5247, 54, 4327, 781, 5248, 521, 6024, 6025, 6026, 6047, 6048, 6067, 6088, 6089, 6091, 5267, 2343, 2656, 3069, 5288, 5289, 5290, 5292, 6127, 6130, 6167, 6168, 6169, 6170, 4507, 5293, 5294, 5295, 4527, 1903, 6192, 6193, 6211, 6231, 6232, 6233, 6251, 6252, 6271, 404, 5387, 5407, 5427, 5447, 6311, 6332, 6335, 6336, 6337, 6338, 6339, 6340, 5487, 5507, 5527, 5547, 5567, 5607, 5627, 6341, 6342, 6371, 6391, 6531, 6511, 5647, 5667, 5687, 5707, 5747, 5767, 5827, 5847, 6512, 6513, 4607, 6571, 3207, 2852, 4227, 2364, 481, 5867, 5887, 5888, 5907, 5908, 5909, 5927, 5947, 5967, 5988, 6651, 506, 6591, 6612, 6613, 2304, 4927, 6671, 765, 660, 6087, 4027, 354, 410, 52, 808, 2356, 756, 6632, 2789, 6633, 2181, 442, 795, 4028, 3647, 4247, 5067, 6672, 6692, 6733, 6735, 6736, 6737, 6738, 6739, 6753, 6754, 6755, 6756, 6757, 6758, 6759, 6760, 6761, 6763, 6764, 6765, 6766, 6767, 6768, 6770, 6773, 6774, 6775, 6776, 6777, 6778, 6779, 6780, 6782, 6784, 6785, 6796, 6798, 6799, 6800, 6802, 6803, 6822, 6823, 6824, 6825, 6826, 6827, 6828, 6829, 6830, 6842, 6843, 6844, 6862, 6863, 6884, 6883, 6885, 6887, 6888, 6889, 6891, 6892, 6893, 6894, 6895, 6896, 6897, 6898, 6769, 306, 187, 320, 6734, 6411, 303, 6899, 6772, 3267, 6771, 4767, 182, 6022, 6797, 6713, 413, 5287, 5587, 3927, 814, 816, 6451, 93, 223, 146, 3931, 2947, 235, 415, 1606, 1501, 537, 3948, 4627, 3877, 758, 763, 2658, 6783, 234, 2653, 291, 388, 2418, 6090, 954, 4207, 469, 504, 6693, 5207, 193, 6291, 6901, 6902, 2221, 419, 6147, 385, 6027, 6903, 6904, 6905, 6906, 6907, 6908, 6923, 6924, 6925, 6926, 6927, 6928, 6929, 6930, 6931, 6932, 6933, 6934, 6935, 6936, 152, 1686, 1921, 6886, 6937, 6938, 6939, 6940, 6941, 6942, 6957, 6958, 6959, 6960, 6961, 6962, 5291, 6801, 6963, 283, 333, 6964, 6965, 6966, 6967, 2351, 173, 295, 6968, 6969, 6971, 6972, 6973, 6974, 6975, 6977, 6978, 6979, 6980, 6981, 6982, 6983, 6984, 6985, 6986, 6987, 6988, 6989, 6990, 6991, 6992, 6993, 6994, 6996, 6997, 6998, 6999, 7000, 7001, 7002, 7003, 7017, 7037, 7077, 7097, 7098, 7117, 7137, 7157, 7158, 7197, 7238, 7257, 7277, 7297, 7298, 7317, 7337, 7357, 7358, 7377, 7417, 7437, 7457, 7537, 7677, 7479, 7517, 7557, 7577, 7597, 7617, 7660, 7717, 7739, 7757, 7758, 7777, 7857, 7797, 7817, 7837, 7877, 7878, 7937, 7957, 7977, 7978, 7997, 8017, 8018, 8037, 8057, 8077, 8097, 8098, 8117, 8137, 8157, 6970, 8179, 8180, 8181, 8182, 6995, 8199, 8200, 8201, 8202, 8205, 8206, 8207, 8208, 8211, 8212, 8213, 8217, 8219, 8220, 8221, 8222, 8837, 8224, 8237, 8227, 8257, 8258, 8259, 8277, 8897, 8337, 8317, 8357, 8358, 8397, 8437, 8457, 8477, 8497, 8517, 8537, 8557, 8559, 8597, 8617, 8677, 8657, 8697, 8699, 8717, 8737, 8757, 8797, 8817, 8857, 8877, 8917, 8918, 8937, 8957, 9037, 9057, 9077, 9097, 9117, 9137, 9157, 9177, 9198, 9199, 9217, 9237, 9257, 8417, 8478, 8577, 8698, 8777, 8997, 9197, 9277, 9317, 9357, 9377, 9397, 9417, 9437, 9477, 9497, 9518, 9557, 9577, 9578, 9597, 9617, 9637, 9657, 9677, 9697, 9698, 9757, 9758, 9777, 9778, 9779, 9780, 9781, 9797, 9817, 9837, 9857, 9877, 9897, 9917, 9937, 9957, 9977, 9978, 10020, 10037, 10077, 10078, 10079, 10097, 10098, 10117, 10137, 10157, 10177, 10217, 10277, 10297, 10317, 8299, 9457, 10337, 10338, 10359, 10361, 10377, 10397, 10417, 10418, 10419, 9337, 8226, 10237, 10437, 10457, 10458, 10459, 10460, 10477, 10497, 10517, 10537, 10557, 10577, 10597, 10598, 10617, 10637, 10657, 10677, 10697, 10717, 10719, 10737, 10757, 10758, 10777, 10797, 10798, 10817, 10837, 10838, 10857, 10859, 10877, 10897, 10898, 10899, 10917, 10937, 10938, 10957, 10977, 10978, 10979, 10980, 10997, 10999, 11000, 11017, 11018, 11037, 11038, 11039, 11040, 11041, 11057, 11058, 11077, 11097, 11117, 11137, 11138, 11139, 11140, 11141, 11142, 11143, 11144, 11145, 11146, 11147, 11198, 11158, 11159, 11177, 11178, 11197, 11199, 11217, 11237, 11238, 11239, 11257, 11277, 11297, 11317, 11318, 11319, 11337, 11357, 11358, 11377, 11378, 11397, 11417, 11418, 11419, 11420, 11421, 11422, 11423, 11424, 11425, 11426, 11427, 11428, 11457, 11458, 11459, 11460, 11461, 11477, 11497, 11498, 11499, 11500, 11537, 11557, 11577, 11578, 11597, 11598, 11599, 11600, 11601, 11617, 11618, 11637, 11638, 11657, 11677, 11717, 11718, 11719, 11720, 11721, 11737, 11758, 11777, 11797, 11817, 11837, 11857, 11877, 11897, 11898, 11899, 11900, 11917, 11937, 7177, 11957, 11997, 12017, 12018, 12037, 12118, 12077, 12117, 12137, 12157, 12177, 12197, 12217, 12237, 12257, 12277, 12297, 12317, 12318, 12337, 12357, 11098, 12377, 12397, 12417, 12437, 12457, 12477, 12478, 12479, 12497, 12517, 12537, 12557, 12577, 12597, 12617, 10939, 12637, 12638, 12657, 12658, 12677, 12697, 12717, 12737, 12757, 9717, 12777, 9297, 12797, 12817, 12837, 12857, 12858, 10257, 12877, 12897, 12917, 12937, 12938, 12939, 12957, 12958, 12977, 12978, 12997, 13017, 13037, 13057, 13077, 8377, 13097, 13098, 13117, 13137, 13157, 13177, 13178, 13179, 13197, 13198, 13217, 13237, 13257, 13277, 13297, 13317, 13337, 13357, 9737, 13377, 11099, 13397, 13417, 13437, 13457, 13477, 13497, 13517, 13537, 13538, 13557, 13577, 13597, 13617, 13637, 13657, 13677, 13697, 13717, 13737, 13777, 6611, 322, 13797, 13817, 13837, 13857, 13877, 13917, 13937, 13957, 14037, 14057, 14058, 14077, 14097, 14117, 7057, 14157, 4188, 14177, 14178, 14197, 14217, 63, 14237, 14257, 14277, 14297, 14317, 13977, 14337, 14017, 14018, 14338, 14357, 2807, 14137, 14378, 357, 14397, 14398, 14399, 13858, 14457, 14477, 14497, 14517, 14537, 14538, 14539, 14540, 14557, 14558, 14577, 14617, 14637, 14657, 14677, 14697, 14717, 6976, 14737, 14757, 14758, 14777, 14778, 14779, 14797, 14817, 14877, 14878, 14879, 14880, 14881, 14882, 14883, 14884, 14897, 14918, 14920, 14922, 14978, 14979, 14980, 15017, 15018, 15019, 15021, 15025, 15026, 15037, 15039, 15041, 15058, 15059, 15078, 15079, 15097, 15098, 15138, 15139, 15141, 15157, 15158, 15159, 15177, 15197, 15199, 15217, 15238, 15257, 15277, 15278, 15297, 15317, 15337, 15357, 15377, 15457, 15437, 15478, 15479, 15480, 15481, 15482, 15483, 15484, 15485, 15497, 15498, 15517, 15518, 15519, 15520, 15521, 15522, 15523, 15537, 15538, 15539, 15540, 15541, 15542, 15543, 15544, 15545, 15546, 15547, 15548, 15557, 15558, 15577, 15578, 15579, 15580, 15581, 15597, 15617, 15618, 15620, 15621, 15622, 15623, 15624, 15625, 15626, 15627, 15628, 15629, 15637, 15638, 15639, 15657, 15658, 15677, 15678, 15697, 15698, 15699, 15700, 15701, 15702, 15717, 15718, 15719, 15797, 15817, 15818, 15837, 15838, 15857, 15877, 15897, 15917, 15937, 15938, 15939, 15940, 15958, 15959, 15960, 15977, 15997, 15998, 16017, 16038, 16057, 16058, 16059, 16077, 16078, 16097, 16098, 16117, 16137, 16157, 16197, 16217, 16237, 16238, 16257, 16258, 16297, 16299, 16317, 16319, 16357, 16358, 16397, 16398, 16417, 16418, 16438, 16458, 16517, 16537, 16538, 16597, 16598, 16599, 16617, 16618, 16637, 16638, 16658, 16678, 16697, 16717, 16718, 16737, 17017, 16797, 16817, 16837, 16838, 16839, 16840, 16857, 16937, 17037, 17057, 17077, 17097, 17137, 17157, 17177, 17197, 17237, 17257, 17277, 17297, 17317, 17337, 17377, 17397, 17417, 17457, 17517, 17537, 17617, 17637, 17677, 17697, 17699, 17718, 17720, 17721, 17722, 17737, 17738, 17741, 17742, 17743, 17744, 17757, 17758, 17797, 17798, 17799, 17800, 17801, 17802, 17803, 17804, 17817, 17818, 17819, 17820, 17837, 17838, 17839, 17857, 17858, 17859, 17877, 17897, 17917, 17937, 17938, 17957, 17977, 18017, 18037, 18058, 18077, 18097, 18098, 17597, 18117, 17698, 17759, 16657, 17557, 17717, 17719, 16177, 16218, 16777, 17657, 15057, 16377, 15757, 15178, 16437, 15117, 17437, 17740, 16477, 16497, 15118, 15038, 16997, 15040, 18137, 18157, 16037, 18217, 18237, 18257, 18277, 18297, 18317, 16298, 14937, 18397, 18377, 18417, 16498, 16917, 18437, 18457, 18458, 18477, 18478, 18479, 18497, 18498, 18517, 18518, 18537, 18538, 18539, 18557, 18558, 17497, 18577, 18597, 15777, 18617, 18637, 18677, 18697, 15477, 17217, 18717, 15798, 14857, 17357, 15022, 15023, 14917, 16897, 14997, 15237, 9537, 15200, 16677, 16318, 15582, 16337, 16457, 16577, 18737, 18757, 18777, 18778, 18797, 18798, 18799, 18800, 18817, 18818, 18819, 18837, 18838, 18857, 18858, 18877, 18878, 18897, 18898, 18899, 18900, 18917, 16877, 9918, 18937, 18957, 18977, 18997, 19017, 19037, 19038, 19077, 19097, 19098, 19117, 19118, 19119, 19137, 19138, 19157, 19177, 19197, 19198, 19217, 19218, 19237, 19257, 19277, 19297, 19298, 19317, 19318, 19337, 19357, 19377, 19397, 19417, 19437, 19457, 19477, 19497, 19498, 19517, 19537, 19538, 19557, 19577, 19597, 19617, 19637, 19657, 19658, 19677, 19697, 19717, 19737, 19757, 19758, 19759, 19777, 19778, 19779, 19780, 19797, 19817, 19837, 19857, 19877, 9017]


pbl_zrodla = """select zr_zrodlo_id, zr_tytul
                        from IBL_OWNER.pbl_zrodla"""
pbl_zrodla = pd.read_sql(pbl_zrodla, con=connection).fillna(value = np.nan)

pbl_zrodla = pbl_zrodla[~pbl_zrodla['ZR_ZRODLO_ID'].isin(mamy)]

df_to_gsheet(pbl_zrodla, '1jxOksYyl86qsAKRVSHf2kCNTAveGlSOAk8V3TzYklkA', 'update 25.01.2021')

#utożsamianie tytułów, 25.01.2021

czasopisma_bn = gsheet_to_df('1yXNdzySXeXbS4IVRB7SgdKWhkkHZVzrCfJA8AdJO8cw', 'Sheet1')

lista_pbl = gsheet_to_df('1jxOksYyl86qsAKRVSHf2kCNTAveGlSOAk8V3TzYklkA', 'update 25.01.2021')

# cosine

pbl_lista = lista_pbl['ZR_TYTUL'].to_list()    
bn_lista = czasopisma_bn['bn_magazine'].to_list()   

combinations = list(itertools.product(pbl_lista, bn_lista))

df = pd.DataFrame(combinations, columns=['pbl_magazine', 'bn_magazine'])
df['similarity'] = df.apply(lambda x: get_cosine_result(x['pbl_magazine'], x['bn_magazine']), axis=1)
df = df[df['similarity'] > 0.35].sort_values(['pbl_magazine', 'similarity'], ascending=[True, False])
df_to_gsheet(df, '1V6BreA4_cEb3FRvv53E5ri2Yl1u3Z2x-yQxxBbAzCeo', 'update 25.01.2021')




















